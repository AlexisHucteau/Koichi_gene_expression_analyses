---
title: "R Notebook"
output: html_notebook
---

```{r, include=FALSE}
source("functions.R")

RNAseq_diff_gene_expression_analysis <- list()
Gene_set_diff_analysis <- list()
load("../DATA/Wang_Feng_RNAseq.RData")
RNAseq <- RNAseq_Wang_Feng %>% voom() %>% .$E %>%as.data.frame()
rm(RNAseq_Wang_Feng)
```

```{r}
RNAseq$Gene <- rownames(RNAseq) %>% str_split(., "[|]") %>% lapply(., function(x){
  x[1]
}) %>%
  unlist(.)

gene_rownames <- rownames(RNAseq) %>% str_split(., "[|]") %>% lapply(., function(x){
  x[1]
}) %>%
  unlist(.) %>% 
  unique(.)

RNAseq <- RNAseq %>%
  split(., .$Gene) %>%
  lapply(., function(x){
    l <- length(x[1,]) - 1
    cnames <- colnames(x)[c(1:l)]
    df <- x[,c(1:l)] %>%
      as.matrix(.) %>%
      colSums2(.) %>% 
      data.frame(.) %>%
      t(.) %>%
      data.frame(.)
    colnames(df) <- cnames
    df
  }) %>%
  rbindlist(.) %>% 
  data.frame(.)

rownames(RNAseq) <- gene_rownames

colnames(RNAseq) <- substr(colnames(RNAseq), 2, 12)

Clinical_patient_data <- read.csv("../DATA/Clinical_patient_data.csv")
```

```{r}
CR_vs_OR_factor <- Make_factor(samples = colnames(RNAseq), 
                               samplesheet = Clinical_patient_data, 
                               index_of_samplesheet = 5, 
                               index_name = 9, 
                               First_level = c("CR", "CRi"), 
                               Second_level = c("CRp", "MLFS", "HI", "PR", "SD", "PD"), 
                               condition_A_name = "CR", 
                               condition_B_name = "NR_OR", 
                               mutation_to_ignore = "RUNX1", 
                               column_of_mutation = 2)

RNAseq_diff_gene_expression_analysis[["CR_vs_OR"]] <- Differential_analysis(CR_vs_OR_factor, RNAseq)

Gene_set_diff_analysis[["CR_vs_OR"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["CR_vs_OR"]][["CR-NR_OR"]])
```

```{r}
NR_vs_R_without_RUNX1m_factor <- Make_factor(samples = colnames(RNAseq), 
                              samplesheet = Clinical_patient_data, 
                              index_of_samplesheet = 5, 
                              index_name = 9, 
                              First_level = c("PD", "SD"), 
                              Second_level = c("CR", "CRi", "CRp", "MLFS", "HI", "PR"), 
                              condition_A_name = "NR", 
                              condition_B_name = "R", 
                              mutation_to_ignore = "RUNX1", 
                              column_of_mutation = 2)

RNAseq_diff_gene_expression_analysis[["NR_vs_R_without_RUNX1m"]] <- Differential_analysis(NR_vs_R_without_RUNX1m_factor, RNAseq)

Gene_set_diff_analysis[["NR_vs_R_without_RUNX1m"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["NR_vs_R_without_RUNX1m"]][["NR-R"]])
```



```{r}
NR_vs_R_factor <- Make_factor(samples = colnames(RNAseq), 
                              samplesheet = Clinical_patient_data, 
                              index_of_samplesheet = 5, 
                              index_name = 9, 
                              First_level = c("PD", "SD"), 
                              Second_level = c("CR", "CRi", "CRp", "MLFS", "HI", "PR"), 
                              condition_A_name = "NR", 
                              condition_B_name = "R")

RNAseq_diff_gene_expression_analysis[["NR_vs_R"]] <- Differential_analysis(NR_vs_R_factor, RNAseq)

Gene_set_diff_analysis[["NR_vs_R"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["NR_vs_R"]][["NR-R"]])
```

```{r}
RUNX1m_wt_factor <- Make_factor(samples = colnames(RNAseq), 
                                samplesheet = Clinical_patient_data, 
                                index_of_samplesheet = 2, 
                                index_name = 9, 
                                First_level = c("RUNX1"), 
                                Second_level = c("wt"), 
                                condition_A_name = "RUNX1m", 
                                condition_B_name = "RUNX1_wt",
                                comparing_mutation = T)

RNAseq_diff_gene_expression_analysis[["RUNX1m_vs_RUNX1wt"]] <- Differential_analysis(RUNX1m_wt_factor, RNAseq)

Gene_set_diff_analysis[["RUNX1wt_vs_RUNX1m"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["RUNX1m_vs_RUNX1wt"]][["RUNX1_wt-RUNX1m"]])
```

# MS Viper analyses

```{r}
data(dorothea_hs, package = "dorothea") 
regulons = dorothea_hs %>%
  filter(confidence %in% c("A", "B"))
```


```{r}
CR_vs_OR_factor <- Make_factor(samples = colnames(RNAseq), 
                               samplesheet = Clinical_patient_data, 
                               index_of_samplesheet = 5, 
                               index_name = 9, 
                               First_level = c("CR"), 
                               Second_level = c("CRi", "CRp", "MLFS", "HI", "PR", "SD", "PD"), 
                               condition_A_name = "CR", 
                               condition_B_name = "NR_OR", 
                               mutation_to_ignore = "RUNX1", 
                               column_of_mutation = 2)

ref_CR_Baseline <- CR_vs_OR_factor == "CR"
ref_no_CR_Baseline <- CR_vs_OR_factor == "NR_OR"

CR_msViper <- run_msviper(RNAseq, regulons, use_aracne = T, ref = ref_CR_Baseline, ref_name = "CR", treat = ref_no_CR_Baseline, treat_name = "NR_OR", minsize = 4, ges.filter = T)

CR_vs_OR_msViper_combinatory <- msviperCombinatorial(CR_msViper$mrs, regulators = 25, verbose = FALSE)
CR_vs_OR_msViper_synergy <- msviperSynergy(CR_vs_OR_msViper_combinatory, verbose = FALSE)


# png(filename = "../Results/CR_msViper.ong")
# plot(CR_msViper$mrs)
# dev.off()
# png("../Results/CR_vs_OR_msViper_synergy.png")
# plot(CR_vs_OR_msViper_synergy)
# dev.off()


```

```{r}
ref_RUNX1m_Baseline <- RUNX1m_wt_factor == "RUNX1m"
ref_RUNX1wt_Baseline <- RUNX1m_wt_factor == "RUNX1_wt"

RUNX1m_msViper <- run_msviper(RNAseq, regulons, use_aracne = T, ref = ref_RUNX1wt_Baseline, ref_name = "WT", treat = ref_RUNX1m_Baseline, treat_name = "RUNX1m", minsize = 4, ges.filter = T)

RUNX1m_msViper_combinatory <- msviperCombinatorial(RUNX1m_msViper$mrs, regulators = 25, verbose = FALSE)
RUNX1m_msViper_synergy <- msviperSynergy(RUNX1m_msViper_combinatory, verbose = FALSE)
```

