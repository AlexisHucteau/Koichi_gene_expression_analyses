---
title: "R Notebook"
output: html_notebook
---

# Initialisation

## Packages & functions

```{r, include=FALSE}
source("functions.R")
```

## DATA

```{r, include=FALSE}
RNAseq_diff_gene_expression_analysis <- list()
Gene_set_diff_analysis <- list()
RNAseq <- read.csv("DATA/RNAseq_parsed.csv", row.names = 1, header = T, check.names = F)
Clinical_patient_data <- read.csv("DATA/Clinical_patient_data.csv")
```

## PCA

```{r}
PCA_rnaseq <- PCA(t(RNAseq), ncp = 3)

```


# Differential gene expression

```{r}
Factor_R_OR_NR_B_RUNX1m <- Make_factor(Clinical_patient_data, 
                                                colnames(RNAseq),
                                                c("RUNX1"), 
                                                c("CR", "CRi"), 
                                                "R", 
                                                c("MLFS", "HI", "CRp", "PR"), 
                                                "OR",
                                                c("SD", "PD"), 
                                                "NR")

RNAseq_diff_gene_expression_analysis[["R_OR_NR_B_RUNX1m"]] <- Differential_analysis(Factor_R_OR_NR_B_RUNX1m, RNAseq)

Factor_R_OR_NR_B <- Make_factor(Clinical_patient_data, 
                                                colnames(RNAseq),
                                                0, 
                                                c("CR", "CRi"), 
                                                "R", 
                                                c("MLFS", "HI", "CRp", "PR"), 
                                                "OR",
                                                c("SD", "PD"), 
                                                "NR")

RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]] <- Differential_analysis(Factor_R_OR_NR_B, RNAseq)

Factor_REL_Baseline <- as.vector(Factor_R_OR_NR_B)
Factor_REL_Baseline[str_detect(Factor_REL_Baseline, "REL")] <- "REL"
Factor_REL_Baseline <- as.factor(Factor_REL_Baseline)

RNAseq_diff_gene_expression_analysis[["REL_Baseline"]] <- Differential_analysis(Factor_REL_Baseline, RNAseq)
```
## Venn diagramm

```{r}
library(VennDiagram)
List_of_DEG <- list()

Vector_DEG_of_interest <- c("NR.B-OR.B", "NR.B-R.B", "OR.B-R.B", "R.B-R.REL")

for (i in Vector_DEG_of_interest){
  List_of_DEG[[paste(i, "UP", sep = "_")]] <- RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][[i]] %>% dplyr::filter(logFC > 0.75 & P.Value < 0.1) %>% .$ID
  
  List_of_DEG[[paste(i, "DOWN", sep =  "_")]] <- RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][[i]] %>% dplyr::filter(logFC < -0.75 & P.Value < 0.1) %>% .$ID
}

Vector_DEG_of_interest2 <- c("WT.NR.B-WT.OR.B", "WT.NR.B-WT.R.B", "WT.OR.B-WT.R.B", "WT.R.B-WT.R.REL")

for (i in Vector_DEG_of_interest2){
  List_of_DEG[[paste(i, "UP", sep = "_")]] <- RNAseq_diff_gene_expression_analysis[["R_OR_NR_B_RUNX1m"]][[i]] %>% dplyr::filter(logFC > 0.75 & P.Value < 0.1) %>% .$ID
  
  List_of_DEG[[paste(i, "DOWN", sep =  "_")]] <- RNAseq_diff_gene_expression_analysis[["R_OR_NR_B_RUNX1m"]][[i]] %>% dplyr::filter(logFC < -0.75 & P.Value < 0.1) %>% .$ID
}

Vector_DEG_of_interest3 <- c("NR.B-REL", "OR.B-REL", "R.B-REL")

for (i in Vector_DEG_of_interest3){
  List_of_DEG[[paste(i, "UP", sep = "_")]] <- RNAseq_diff_gene_expression_analysis[["REL_Baseline"]][[i]] %>% dplyr::filter(logFC > 0.75 & P.Value < 0.1) %>% .$ID
  
  List_of_DEG[[paste(i, "DOWN", sep =  "_")]] <- RNAseq_diff_gene_expression_analysis[["REL_Baseline"]][[i]] %>% dplyr::filter(logFC < -0.75 & P.Value < 0.1) %>% .$ID
}
```


### No RUNX1m filter

```{r}
Venndiagram_B_df <- list(
  "NR_vs_OR" = c(List_of_DEG$`NR.B-OR.B_UP`, List_of_DEG$`NR.B-OR.B_DOWN`),
  "NR_vs_R" = c(List_of_DEG$`NR.B-R.B_UP`, List_of_DEG$`NR.B-R.B_DOWN`),
  "OR_vs_R" = c(List_of_DEG$`OR.B-R.B_UP`, List_of_DEG$`OR.B-R.B_DOWN`)
)

venn.diagram(Venndiagram_B_df,
             filename = "Results/Figures/Venn_B_DEG.png", 
             imagetype = "png")
```

### RUNX1m filter

```{r}
Venndiagram_B_No_RUNX1_df <- list(
  "NR_vs_OR" = c(List_of_DEG$`WT.NR.B-WT.OR.B_UP`, List_of_DEG$`WT.NR.B-WT.OR.B_DOWN`),
  "NR_vs_R" = c(List_of_DEG$`WT.NR.B-WT.R.B_UP`, List_of_DEG$`WT.NR.B-WT.R.B_DOWN`),
  "OR_vs_R" = c(List_of_DEG$`WT.OR.B-WT.R.B_UP`, List_of_DEG$`WT.OR.B-WT.R.B_DOWN`)
)

venn.diagram(Venndiagram_B_No_RUNX1_df,
             filename = "Results/Figures/Venn_B_DEG_noRUNX1.png", 
             imagetype = "png")
```

## Relapse/Baseline R NR vs R OR vs R

```{r}
Venndiagram_REL_B_df <- list(
  "RBaseline_RRelapse" = c(List_of_DEG$`WT.R.B-WT.R.REL_UP`, List_of_DEG$`WT.R.B-WT.R.REL_DOWN`),
  "NR_vs_R" = c(List_of_DEG$`WT.NR.B-WT.R.B_UP`, List_of_DEG$`WT.NR.B-WT.R.B_DOWN`),
  "OR_vs_R" = c(List_of_DEG$`WT.OR.B-WT.R.B_UP`, List_of_DEG$`WT.OR.B-WT.R.B_DOWN`)
)

venn.diagram(Venndiagram_REL_B_df,
             filename = "Results/Figures/Venndiagram_REL_B_df.png", 
             imagetype = "png")
```


# Gene set enrichment analysis

## Clinical analysis

```{r, include = F}
Gene_set_diff_analysis[["OR_vs_R"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][["OR.B-R.B"]])

Gene_set_diff_analysis[["OR_vs_R_without_RUNX1m"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B_RUNX1m"]][["WT.OR.B-WT.R.B"]])

Gene_set_diff_analysis[["NR_vs_R"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][["NR.B-R.B"]])

Gene_set_diff_analysis[["NR_vs_R_without_RUNX1m"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B_RUNX1m"]][["WT.NR.B-WT.R.B"]])
```

## Intersection NR R OR analyses

```{r}
gene_universe <- rownames(RNAseq)

Genes_UP_NR <- intersect(List_of_DEG$`NR.B-OR.B_UP`, List_of_DEG$`NR.B-R.B_UP`)
Genes_DOWN_NR <- intersect(List_of_DEG$`NR.B-OR.B_DOWN`, List_of_DEG$`NR.B-R.B_DOWN`)

Genes_UP_R <- intersect(List_of_DEG$`NR.B-R.B_DOWN`, List_of_DEG$`OR.B-R.B_DOWN`)
Genes_DOWN_R <- intersect(List_of_DEG$`NR.B-R.B_UP`, List_of_DEG$`OR.B-R.B_UP`)

######################## NR ###########################
Gene_set_diff_analysis[["Intersection_analysis"]] <- list()
Gene_set_diff_analysis[["Intersection_analysis"]][["NR_UP"]] <- enrichGO(
    gene = Genes_UP_NR,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )
Gene_set_diff_analysis[["Intersection_analysis"]][["NR_DOWN"]] <- enrichGO(
    gene = Genes_DOWN_NR,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )

#################### R ########################
Gene_set_diff_analysis[["Intersection_analysis"]][["R_UP"]] <- enrichGO(
    gene = Genes_UP_R,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )
Gene_set_diff_analysis[["Intersection_analysis"]][["R_DOWN"]] <- enrichGO(
    gene = Genes_DOWN_R,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )

rm(Genes_UP_NR, Genes_DOWN_NR, Genes_UP_R, Genes_DOWN_R)
```

## Intersection Relapse R analyses

```{r}
Genes_UP_R_B_UP <- intersect(List_of_DEG$`NR.B-R.B_DOWN`, List_of_DEG$`R.B-R.REL_UP`)
Genes_UP_R_B_DOWN <- intersect(List_of_DEG$`NR.B-R.B_UP`, List_of_DEG$`R.B-R.REL_DOWN`)

Gene_set_diff_analysis[["Intersection_analysis"]][["REL_R_B_UP"]] <- enrichGO(
    gene = Genes_UP_R_B_UP,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )
Gene_set_diff_analysis[["Intersection_analysis"]][["REL_R_B_DOWN"]] <- enrichGO(
    gene = Genes_UP_R_B_DOWN,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )

rm(Genes_UP_R_B_UP, Genes_UP_R_B_DOWN)
```

## Intersection Relapse vs OR analyses

```{r}
Genes_UP_OR_B_UP <- intersect(List_of_DEG$`NR.B-OR.B_DOWN`, List_of_DEG$`OR.B-REL_UP`)
Genes_DOWN_OR_B_DOWN <- intersect(List_of_DEG$`NR.B-OR.B_UP`, List_of_DEG$`OR.B-REL_DOWN`)

Gene_set_diff_analysis[["Intersection_analysis"]][["REL_OR_B_UP"]] <- enrichGO(
    gene = Genes_UP_OR_B_UP,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )
Gene_set_diff_analysis[["Intersection_analysis"]][["REL_OR_B_DOWN"]] <- enrichGO(
    gene = Genes_DOWN_OR_B_DOWN,
    keyType = "SYMBOL",
    OrgDb = "org.Hs.eg.db",
    ont = "ALL",
    pAdjustMethod = "none", 
    universe = gene_universe
  )

rm(Genes_UP_OR_B_UP, Genes_DOWN_OR_B_DOWN)
```



## Relapse versus Baseline R

```{r}
Gene_set_diff_analysis[["REL_B.R"]] <- Gene_set_analysis(RNAseq_diff_gene_expression_analysis[["REL_Baseline"]][["R.B-REL"]])
```

# MS Viper analyses

```{r}
data(dorothea_hs, package = "dorothea") 
regulons = dorothea_hs %>%
  filter(confidence %in% c("A", "B"))

ref_R_B <- Factor_R_OR_NR_B == "R.B"
ref_OR_B <- Factor_R_OR_NR_B == "OR.B"
ref_NR_B <- Factor_R_OR_NR_B == "NR.B"
ref_R_REL <- Factor_R_OR_NR_B == "R.REL" | Factor_R_OR_NR_B == "OR.REL" | Factor_R_OR_NR_B == "NR.REL" 

R_OR_msviper <- Do_MS_viper_analysis(RNAseq, regulons, ref_R_B, "R", ref_OR_B, "OR")

R_NR_msviper <- Do_MS_viper_analysis(RNAseq, regulons, ref_R_B, "R", ref_NR_B, "NR")

OR_NR_msviper <- Do_MS_viper_analysis(RNAseq, regulons, ref_OR_B, "OR", ref_NR_B, "NR")

R_B_REL_msviper <- Do_MS_viper_analysis(RNAseq, regulons, ref_R_B, "R", ref_R_REL, "R_REL")

OR_B_REL_msviper <- Do_MS_viper_analysis(RNAseq, regulons, ref_OR_B, "R", ref_R_REL, "OR_REL")
```

## Intersection 

```{r}
TF_UP_NR_R <- R_NR_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes > 0) %>% .$TF
TF_UP_REL_R <- R_B_REL_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes > 0) %>% .$TF

TF_DOWN_NR_R <- R_NR_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes < 0) %>% .$TF
TF_DOWN_REL_R <- R_B_REL_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes < 0) %>% .$TF

TF_UP_NR_and_REL_vs_R <- c(intersect(TF_UP_NR_R, TF_UP_REL_R), intersect(TF_DOWN_NR_R,TF_DOWN_REL_R))



TF_UP_OR_R <- R_OR_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes > 0) %>% .$TF
TF_UP_REL_OR <- OR_B_REL_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes > 0) %>% .$TF

TF_DOWN_OR_R <- R_OR_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes < 0) %>% .$TF
TF_DOWN_REL_OR <- OR_B_REL_msviper[["MSVIPER"]]$mrs_table %>% dplyr::filter(pval < 0.1 & nes < 0) %>% .$TF

TF_UP_NR_and_REL_vs_OR <- c(intersect(TF_UP_OR_R, TF_UP_REL_R), intersect(TF_DOWN_OR_R, TF_DOWN_REL_R))

rm(TF_UP_NR_R, TF_UP_REL_R, TF_DOWN_NR_R, TF_DOWN_REL_R, TF_UP_OR_R, TF_UP_REL_OR, TF_DOWN_OR_R, TF_DOWN_REL_OR)
```

# Preparing Combining Networks

```{r}
PPI_Network <- read.csv("DATA/FIsInGene_020720_with_annotations.tsv", sep = "\t")

# attribute value	explanation
# ECrel	enzyme-enzyme relation, indicating two enzymes catalyzing successive reaction steps
# PPrel	protein-protein interaction, such as binding and modification
# GErel	gene expression interaction, indicating relation of transcription factor and target gene product
# PCrel	protein-compound interaction
# maplink	link to another map

PPI_Network$Edge_ID <- paste(PPI_Network$Gene1, PPI_Network$Gene2, sep = ".")

Combined_Networks <- regulons
Combined_Networks$Edge_ID <- paste(Combined_Networks$tf, Combined_Networks$target, sep = ".")

Combined_Networks <- merge(Combined_Networks, PPI_Network, by = "Edge_ID", all = T)
Combined_Networks$Gene1 <- ifelse(is.na(Combined_Networks$Gene1), Combined_Networks$tf, Combined_Networks$Gene1)
Combined_Networks$Gene2 <- ifelse(is.na(Combined_Networks$Gene2), Combined_Networks$target, Combined_Networks$Gene2)
Combined_Networks <- Combined_Networks[,c(6, 7, 3, 5, 8:10)]
colnames(Combined_Networks) <- c("Gene_IN", "Gene_Out", "confidence", "Tf_Regulation", "PPI_Annotation", "Direction_PPI", "Score_PPI")

Combined_Networks$Tf_Regulation <- ifelse(is.na(Combined_Networks$Tf_Regulation), 0, Combined_Networks$Tf_Regulation)
Combined_Networks$confidence <- ifelse(is.na(Combined_Networks$confidence), "", Combined_Networks$confidence)
Combined_Networks$PPI_Annotation <- ifelse(is.na(Combined_Networks$PPI_Annotation), "", Combined_Networks$PPI_Annotation)
Combined_Networks$Direction_PPI <- ifelse(is.na(Combined_Networks$Direction_PPI), "", Combined_Networks$Direction_PPI)
Combined_Networks$Score_PPI <- ifelse(is.na(Combined_Networks$Score_PPI), 0.0, Combined_Networks$Score_PPI)

GErel_annotations <- c("GErel", "regulat", "repress", "expression")
PPrel_annotations <-c("activat", "binding", "catalyze", "complex", "compound", "phosphyr", "dissocia", "effect", "glycol", "interact", "methyla", "PPrel", "state", "ubiqui")
ECrel_annotation <- c("ECrel", "reaction")

tmp <- sapply(Combined_Networks$PPI_Annotation, function(x){
  GE_test <- sapply(GErel_annotations, function(GE){
    (str_detect(x, GE))*1
  }) %>% sum() > 0
  EC_test <- sapply(ECrel_annotation, function(EC){
    (str_detect(x, EC))*1
  }) %>% sum() > 0
  PP_test <- sapply(PPrel_annotations, function(PP){
    (str_detect(x, PP))*1
  }) %>% sum() > 0
  predicted_test <- str_detect(x, "predicted")
  ifelse(GE_test, "GErel", ifelse(EC_test, "ECrel", ifelse(PP_test, "PPrel", ifelse(predicted_test, "predicted", "other"))))
})

Combined_Networks$Cleaned_PPI_annotation <- tmp
```




# Saving

## Tables

```{r}
table_dir <- "Results/Tables/"
```


### DEG

```{r}
write.csv(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][["NR.B-R.B"]], paste0(table_dir, "DEG_NR_vs_R.csv"), row.names = T)
write.csv(RNAseq_diff_gene_expression_analysis[["REL_Baseline"]][["R.B-REL"]], paste0(table_dir, "DEG_R_vs_REL.csv"), row.names = T)

Double_DEG_NR_R_REL <- merge(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][["NR.B-R.B"]], RNAseq_diff_gene_expression_analysis[["REL_Baseline"]][["R.B-REL"]], by="ID") %>%
  merge(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][["OR.B-R.B"]], by = "ID") %>%
  merge(RNAseq_diff_gene_expression_analysis[["R_OR_NR_B"]][["NR.B-OR.B"]], by = "ID")
Double_DEG_NR_R_REL <- Double_DEG_NR_R_REL[, c(1, 2, 5, 8, 11, 14, 17, 20, 23)]
colnames(Double_DEG_NR_R_REL) <- c("ID", "NR_R_logFC", "NR_R_P.Value", "R_REL_logFC", "R_REL_P.Value", "OR_R_logFC", "OR_R_P.Value", "NR_OR_logFC", "NR_OR_P.Value")

write.csv(Double_DEG_NR_R_REL, paste0(table_dir, "Double_DEG_NR_R_REL.csv"), row.names = F)
```

### MS_viper

```{r}
write.csv(R_NR_msviper[["MSVIPER"]]$mrs_table, "Results/Tables/NR_vs_R_msviper.csv", row.names = F)
write.csv(R_OR_msviper[["MSVIPER"]]$mrs_table, "Results/Tables/OR_vs_R_msviper.csv", row.names = F)
write.csv(R_B_REL_msviper[["MSVIPER"]]$mrs_table, "Results/Tables/REL_vs_R_msviper.csv", row.names = F)

Double_MS_Viper_NR_R_REL <- merge(R_NR_msviper[["MSVIPER"]]$mrs_table, R_B_REL_msviper[["MSVIPER"]]$mrs_table, by = "TF") %>%
  merge(R_OR_msviper[["MSVIPER"]]$mrs_table, by = "TF") %>%
  merge(OR_NR_msviper[["MSVIPER"]]$mrs_table, by = "TF")

Double_MS_Viper_NR_R_REL <- Double_MS_Viper_NR_R_REL[, c(1, 3, 4, 7, 8, 11, 12, 15, 16)]
colnames(Double_MS_Viper_NR_R_REL) <- c("ID", "NR_R_nes", "NR_R_pval", "REL_R_nes", "REL_R_pval", "OR_R_nes", "OR_R_pval", "NR_OR_nes", "NR_OR_pval")

write.csv(Double_MS_Viper_NR_R_REL, paste0(table_dir, "Double_MS_Viper_NR_R_REL.csv"), row.names = F)
```

### Networks

```{r}
write.table(Combined_Networks, "Results/Tables/Combined_Networks.tsv", row.names = F, sep = "\t", quote = FALSE)
```



## Figures

```{r}
fig_dir <- "Results/Figures/"
```

### GO

```{r}
png("Results/Figures/GO_NR_R.png", width = 720, height = 720*9/16)
dotplot(Gene_set_diff_analysis[["NR_vs_R"]], showCategory=10, split=".sign") + facet_grid(.~.sign)
dev.off()

png("Results/Figures/GO_Rel_R.png", width = 720, height = 720*9/16)
dotplot(Gene_set_diff_analysis[["REL_B.R"]], showCategory=10, split=".sign") + facet_grid(.~.sign)
dev.off()



png("Results/Figures/GO_NR_UP.png")
emapplot(Gene_set_diff_analysis[["Intersection_analysis"]][["NR_UP"]], color = "qvalue", size = "Count")
dev.off()
png("Results/Figures/GO_NR_DOWN.png")
emapplot(Gene_set_diff_analysis[["Intersection_analysis"]][["NR_DOWN"]], color = "qvalue", size = "Count")
dev.off()

png("Results/Figures/GO_R_UP.png")
emapplot(Gene_set_diff_analysis[["Intersection_analysis"]][["R_UP"]], color = "qvalue", size = "Count")
dev.off()

png("Results/Figures/GO_REL_R_B_DOWN.png")
emapplot(Gene_set_diff_analysis[["Intersection_analysis"]][["REL_R_B_DOWN"]], color = "qvalue", size = "Count")
dev.off()
```

### MS_VIPER

```{r}
png(paste0(fig_dir, "MS_Viper_NR_R.png"))
plot(R_NR_msviper[["MSVIPER"]]$mrs)
dev.off()
png(paste0(fig_dir, "MS_Viper_OR_R.png"))
plot(R_OR_msviper[["MSVIPER"]]$mrs)
dev.off()
png(paste0(fig_dir, "MS_Viper_REL_R.png"))
plot(R_B_REL_msviper[["MSVIPER"]]$mrs)
dev.off()
```

